# Backend Integration for SQL Validation

## Quick Integration Guide

Since your agents use **AI-generated SQL queries** (not manually edited SQL), the validation should happen **during query generation/execution**, not during agent editing.

### ✅ Integration Point: Agent Execution

The validation API should be called **after the AI generates a query** but **before executing it**.

---

## Step 1: Register the SQL Validation Router

Add the validation endpoints to your `main.py`:

```python
# In backend/main.py

from api.sql_validation import router as sql_validation_router

# ... existing code ...

# Register the SQL validation router
app.include_router(sql_validation_router)
```

---

## Step 2: Integrate into Agent Execution

In your agent execution flow, add validation after query generation:

```python
# In backend/services/agent_service.py (or wherever queries are generated)

from utils.defensive_sql_validator import validate_sql

async def execute_agent_query(agent_id: str, generated_query: str):
    """Execute an agent's query with validation"""
    
    # Step 1: Validate the generated query
    validation_result = validate_sql(generated_query, auto_fix=True)
    
    if not validation_result['is_valid']:
        # Log the issues
        logger.warning(f"Query validation issues for agent {agent_id}:")
        for issue in validation_result['issues']:
            logger.warning(f"  - [{issue['severity']}] {issue['message']}")
        
        # Use the fixed query if auto-fix was successful
        if validation_result['fixed_query']:
            logger.info(f"Applied {len(validation_result['fixes_applied'])} fixes:")
            for fix in validation_result['fixes_applied']:
                logger.info(f"  ✓ {fix}")
            
            query_to_execute = validation_result['fixed_query']
        else:
            query_to_execute = generated_query
    else:
        query_to_execute = generated_query
    
    # Step 2: Execute the query
    result = await execute_postgres_query(query_to_execute)
    
    return result
```

---

## Step 3: Add Validation to Query Correction Flow

Your system already has auto-correction. Enhance it with defensive SQL validation:

```python
# In the query correction flow (where AI fixes errors)

def correct_failed_query(original_query: str, error_message: str):
    """Correct a failed query using AI"""
    
    # Step 1: Let AI attempt to fix the error
    corrected_query = ai_correct_query(original_query, error_message)
    
    # Step 2: Validate the corrected query
    validation_result = validate_sql(corrected_query, auto_fix=True)
    
    if not validation_result['is_valid']:
        # Apply defensive SQL fixes
        if validation_result['fixed_query']:
            logger.info("Applied defensive SQL patterns to corrected query")
            return validation_result['fixed_query']
    
    return corrected_query
```

---

## Step 4: Optional - Add Validation Endpoint for Testing

The API endpoints are already created. To test them:

```bash
# Test validation
curl -X POST http://localhost:8000/api/sql/validate \
  -H "Content-Type: application/json" \
  -d '{
    "query": "SELECT (i.due_date->>'\''value'\'')::date FROM icap_invoice i",
    "auto_fix": false
  }'

# Test auto-fix
curl -X POST http://localhost:8000/api/sql/auto-fix \
  -H "Content-Type: application/json" \
  -d '{
    "query": "SELECT (i.due_date->>'\''value'\'')::date FROM icap_invoice i"
  }'
```

---

## Summary

### Where Validation Applies:

1. **✅ During Agent Execution** (Recommended)
   - After AI generates query
   - Before executing query
   - Auto-fix applied automatically

2. **✅ During Query Correction** (Recommended)
   - After AI corrects a failed query
   - Before retrying execution
   - Ensures corrected query follows defensive patterns

3. **❌ NOT in Agent Editing UI**
   - Your UI edits the **prompt**, not the SQL
   - SQL is generated by AI during execution
   - No need for frontend validation

### Implementation Checklist:

- [ ] Add `app.include_router(sql_validation_router)` to `main.py`
- [ ] Integrate `validate_sql()` into agent execution flow
- [ ] Add validation to query correction flow
- [ ] Test with a few agents
- [ ] Monitor logs for validation issues

### Result:

All AI-generated queries will be automatically validated and fixed before execution, ensuring they follow the 4 golden rules!
